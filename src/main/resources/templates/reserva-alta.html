<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alta de Reserva</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body>
    <div class="container mt-5">
        <h1 class="text-center mb-4">Alta de Reserva</h1>

        <div class="alert alert-warning" th:if="${error}">
            No s'ha pogut donar d'alta la reserva perquè hi ha un error amb els clients o vehicles.
        </div>

        <form th:action="@{/reserva/alta}" method="post">
            <div class="mb-3">
                <label for="client" class="form-label">Client</label>
                <select id="client" name="client.dni" class="form-select" required>
                    <option th:each="client : ${clients}" th:value="${client.dni}"
                        th:text="${client.nom + ' ' + client.cognoms}"></option>
                </select>
            </div>

            <div class="mb-3">
                <label for="vehicle" class="form-label">Vehicle</label>
                <select id="vehicle" name="vehicle.matricula" class="form-select" required>
                    <option th:each="vehicle : ${vehicles}" th:value="${vehicle.matricula}"
                        th:text="${vehicle.marca + ' ' + vehicle.model}"></option>
                </select>
            </div>

            <div class="mb-3">
                <label for="dataInici" class="form-label">Data d'Inici</label>
                <input type="date" id="dataInici" name="dataInici" class="form-control" th:value="${reserva?.dataInici}"
                    required>
                <div id="dataIniciError" class="text-danger" style="display: none;">
                    La data d'inici no pot ser anterior a avui.
                </div>
            </div>

            <div class="mb-3">
                <label for="dataFi" class="form-label">Data de Finalització</label>
                <input type="date" id="dataFi" name="dataFi" class="form-control" th:value="${reserva?.dataFi}"
                    required>
                <div id="dataFinalError" class="text-danger" style="display: none;">
                    La data de finalització no pot ser anterior a la data d'inici.
                </div>
            </div>

            <div class="mb-3">
                <label for="horaInici" class="form-label">Hora de lliurar: </label>
                <input type="time" id="horaInici" name="horaInici" class="form-control" th:value="${reserva?.horaInici}"
                    required>
            </div>
            <div class="mb-3">
                <label for="horaFi" class="form-label">Hora de retorn: </label>
                <input type="time" id="horaFi" name="horaFi" class="form-control" th:value="${reserva?.horaFi}"
                    required>
            </div>

            <div class="mb-3">
                <label for="fianca">Fiança:</label>
                <input type="text" id="fianca" name="fianca" class="form-control" th:value="${fianca}" readonly>
            </div>

            <!-- Cost Total -->
            <div class="mb-3">
                <label for="costTotal">Preu total:</label>
                <input type="text" id="costTotal" name="costTotal" class="form-control" th:value="${costTotal}"
                    readonly>
            </div>

            <div class="d-flex justify-content-between">
                <button type="submit" class="btn btn-warning" th:formaction="@{/reserva/alta/calculPreu}"
                    formmethod="post">Actualitzar Preus</button>
                <button type="submit" class="btn btn-primary">Guardar</button>
                <a href="/reserva/llistar" class="btn btn-secondary">Cancel·lar</a>
            </div>
        </form>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const dataIniciInput = document.getElementById("dataInici");
            const dataFinalInput = document.getElementById("dataFi");

            const dataIniciError = document.getElementById("dataIniciError");
            const dataFinalError = document.getElementById("dataFinalError");

            const updatePricesButton = document.querySelector("button[formmethod='post']");
            const saveButton = document.querySelector("button.btn-primary");

            const form = document.getElementById("reservaForm");

            const currentDate = new Date();

            // Recuperar estado del almacenamiento local
            let pricesUpdated = localStorage.getItem("pricesUpdated") === "true";

            // Configurar atributos min para las fechas
            const formatDate = (date) => {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            };

            const currentDateString = formatDate(currentDate);

            dataIniciInput.setAttribute("min", currentDateString);
            dataFinalInput.setAttribute("min", currentDateString);

            // Desactivar el botón de guardar inicialmente si los precios no están actualizados
            saveButton.disabled = !pricesUpdated;

            // Validar fechas en tiempo real
            dataIniciInput.addEventListener("input", handleDateChange);
            dataFinalInput.addEventListener("input", handleDateChange);

            updatePricesButton.addEventListener("click", function () {
                pricesUpdated = true;
                localStorage.setItem("pricesUpdated", "true"); // Guardar estado en localStorage
                saveButton.disabled = false; // Habilitar botón de guardar después de actualizar precios
            });

            form.addEventListener("submit", function (event) {
                if (!validateDates()) {
                    event.preventDefault();
                    alert("Revisa les dates abans d'enviar. Algunes no són vàlides.");
                } else {
                    // Si se va a guardar, limpiar el estado de precios del localStorage
                    localStorage.removeItem("pricesUpdated");
                }
            });

            function handleDateChange() {
                pricesUpdated = false; // Marcar que los precios ya no están actualizados
                localStorage.setItem("pricesUpdated", "false"); // Guardar estado en localStorage
                saveButton.disabled = true; // Desactivar botón de guardar
                validateDates(); // Validar las fechas después del cambio
            }

            function validateDates() {
                let isValid = true;

                const dataInici = new Date(dataIniciInput.value);
                const dataFinal = new Date(dataFinalInput.value);

                // Validar dataInici
                if (!dataIniciInput.value || dataInici < currentDate) {
                    dataIniciError.style.display = "block";
                    isValid = false;
                } else {
                    dataIniciError.style.display = "none";
                }

                // Validar dataFinal
                if (!dataFinalInput.value || dataFinal <= dataInici) {
                    dataFinalError.style.display = "block";
                    isValid = false;
                } else {
                    dataFinalError.style.display = "none";
                }

                return isValid;
            }
        });
    </script>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const dataIniciInput = document.getElementById("dataInici");
            const dataFinalInput = document.getElementById("dataFi");

            const dataIniciError = document.getElementById("dataIniciError");
            const dataFinalError = document.getElementById("dataFinalError");

            const form = document.getElementById("reservaForm");

            const currentDate = new Date();

            // Configurar atributos min para las fechas
            const formatDate = (date) => {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            };

            const currentDateString = formatDate(currentDate);

            dataIniciInput.setAttribute("min", currentDateString);
            dataFinalInput.setAttribute("min", currentDateString);

            // Validar fechas en tiempo real
            dataIniciInput.addEventListener("input", validateDates);
            dataFinalInput.addEventListener("input", validateDates);

            form.addEventListener("submit", function (event) {
                if (!validateDates()) {
                    event.preventDefault();
                    alert("Revisa les dates abans d'enviar. Algunes no són vàlides.");
                }
            });

            function validateDates() {
                let isValid = true;

                const dataInici = new Date(dataIniciInput.value) + 1;
                const dataFinal = new Date(dataFinalInput.value) + 1;

                // Validar dataInici
                if (!dataIniciInput.value || dataInici < currentDate) {
                    dataIniciError.style.display = "block";
                    isValid = false;
                } else {
                    dataIniciError.style.display = "none";
                }

                // Validar dataFinal
                if (!dataFinalInput.value || dataFinal < dataInici) {
                    dataFinalError.style.display = "block";
                    isValid = false;
                } else {
                    dataFinalError.style.display = "none";
                }

                return isValid;
            }
        });
    </script>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>